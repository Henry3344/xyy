<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Survival English Guide v24.0</title>
    <style>
        /* --- CSS å˜é‡ --- */
        :root {
            --bg-body: #f2f2f7;
            --bg-card: #ffffff;
            --text-main: #1c1c1e;
            --text-sub: #636366;
            --primary: #007aff;
            --primary-light: #e5f1ff;
            --border: #c6c6c8;
            --chip-bg: #ffffff;
            --chip-border: #d1d1d6;
            --nav-bg: rgba(255,255,255,0.95);
            --shadow: rgba(0,0,0,0.08);
            --display-area: #f2f2f7;
            --danger: #ff3b30;
            --accent: #5856d6;
        }

        [data-theme="dark"] {
            --bg-body: #000000;
            --bg-card: #1c1c1e;
            --text-main: #ffffff;
            --text-sub: #aeaeb2;
            --primary: #0a84ff;
            --primary-light: #1c1c1e;
            --border: #38383a;
            --chip-bg: #2c2c2e;
            --chip-border: #3a3a3c;
            --nav-bg: rgba(28,28,30,0.95);
            --shadow: rgba(255,255,255,0.05);
            --display-area: #2c2c2e;
            --danger: #ff453a;
            --accent: #5e5ce6;
        }

        /* --- åŸºç¡€å¸ƒå±€ --- */
        html, body { height: 100%; overflow: hidden; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; padding: 0;
            display: flex;
            flex-direction: column;
            transition: background 0.3s, color 0.3s; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* --- é¡¶éƒ¨æ§åˆ¶å° --- */
        .header-container { 
            flex: 0 0 auto;
            background: var(--nav-bg); 
            backdrop-filter: blur(15px); 
            z-index: 1000; 
            border-bottom: 1px solid var(--border); 
            box-shadow: 0 4px 15px var(--shadow); 
            padding-top: env(safe-area-inset-top);
        }
        
        .top-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; max-width: 650px; margin: 0 auto; }
        .app-title { font-size: 1.1em; font-weight: 800; color: var(--text-main); margin: 0; }
        .header-actions { display: flex; gap: 12px; }
        .icon-btn { background: none; border: 1px solid var(--border); color: var(--text-main); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1em; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .icon-btn.danger { border-color: var(--danger); color: var(--danger); font-weight: bold; }
        
        .search-row { padding: 0 15px 8px 15px; max-width: 650px; margin: 0 auto; }
        .search-input { width: 100%; padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); font-size: 0.95em; box-sizing: border-box; outline: none; transition: border 0.2s; }
        .search-input:focus { border-color: var(--primary); }

        .nav-scroll { display: flex; overflow-x: auto; padding: 0 15px 10px 15px; gap: 8px; max-width: 650px; margin: 0 auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .nav-scroll::-webkit-scrollbar { display: none; }
        .nav-btn { flex: 0 0 auto; background: var(--primary-light); color: var(--primary); border: 1px solid transparent; padding: 5px 10px; border-radius: 14px; font-weight: 600; font-size: 0.8em; text-decoration: none; transition: all 0.2s; white-space: nowrap; cursor: pointer; }
        [data-theme="dark"] .nav-btn { border-color: var(--border); }
        .nav-btn.active-nav { background: var(--primary); color: white; }

        /* --- ä¸»å†…å®¹åŒº --- */
        #content-area {
            flex: 1;
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-snap-type: x mandatory; 
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding: 15px 7.5vw; 
            gap: 15px;
            align-items: flex-start;
        }
        #content-area::-webkit-scrollbar { display: none; }

        /* --- å•å…ƒå¡ç‰‡ --- */
        .unit-card { 
            flex: 0 0 85vw; 
            max-width: 500px;
            background: var(--bg-card); 
            border-radius: 20px; 
            padding: 20px; 
            box-shadow: 0 8px 30px var(--shadow); 
            border: 1px solid var(--border); 
            scroll-snap-align: center; 
            scroll-snap-stop: always;
            box-sizing: border-box;
            height: 98%; 
            max-height: 85vh; 
            overflow-y: auto; 
            overflow-x: hidden;
            position: relative;
            transition: transform 0.2s;
        }
        .unit-card::-webkit-scrollbar { display: none; }

        .unit-header { font-size: 1.3em; font-weight: 800; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--display-area); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .sort-rank { font-size: 0.6em; color: var(--text-sub); font-weight: normal; opacity: 0.5; background: var(--display-area); padding: 2px 6px; border-radius: 4px; }

        /* --- æ­¥éª¤åŒºåŸŸ --- */
        .step-container { margin-bottom: 20px; width: 100%; }
        .step-label { font-size: 0.75em; color: var(--text-sub); font-weight: 700; margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .pattern-box { 
            font-family: "Menlo", monospace; color: #d63031; background: #ffeaea; padding: 2px 6px; border-radius: 4px; font-size: 1em; margin-left: 5px; border: 1px solid #ffcccc; display: inline-block; margin-top: 4px; 
            white-space: normal; word-wrap: break-word; 
        }
        [data-theme="dark"] .pattern-box { background: #3e1a1a; border-color: #5c1e1e; color: #ff6b6b; }

        /* --- ä¸»å¥æ˜¾ç¤ºåŒº --- */
        .display-area { 
            background-color: var(--display-area); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; gap: 10px; transition: background 0.3s; border: 1px solid var(--border); 
            width: 100%; box-sizing: border-box; 
        }
        .text-content { flex-grow: 1; min-width: 0; }
        .english-sentence { 
            font-size: 1.25em; font-weight: 600; line-height: 1.3; color: var(--text-main); margin-bottom: 4px; 
            white-space: normal; word-wrap: break-word; 
        }
        .highlight { color: var(--primary); text-decoration: underline; text-decoration-thickness: 3px; text-underline-offset: 4px; cursor: pointer; }
        .translation { color: var(--text-sub); font-size: 0.9em; white-space: normal; }
        
        /* --- æŒ‰é’® --- */
        .btn-audio { flex-shrink: 0; background: var(--bg-card); border: 1px solid var(--border); border-radius: 50%; width: 40px; height: 40px; min-width: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1em; box-shadow: 0 2px 5px var(--shadow); color: var(--primary); }
        .btn-audio:active { transform: scale(0.92); }
        
        /* --- è¯æ±‡ç‚¹å‡»åŒº --- */
        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; width: 100%; transition: padding-bottom 0.3s ease; }
        .chip { 
            background: var(--chip-bg); border: 1px solid var(--chip-border); 
            padding: 6px 12px; border-radius: 16px; 
            font-size: 0.9em; cursor: pointer; font-weight: 600; color: var(--text-main); 
            transition: all 0.2s; user-select: none; 
            max-width: 100%; white-space: normal; word-wrap: break-word; 
        }
        .chip:hover { transform: translateY(-1px); border-color: var(--primary); }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 8px rgba(0,122,255,0.3); transform: scale(1.02); }
        
        /* æŒ‰é’®å®¹å™¨ */
        .add-btn-wrapper { position: relative; display: inline-block; vertical-align: middle; }
        .add-chip-btn { border: 1px dashed var(--text-sub); color: var(--text-sub); background: transparent; padding: 6px 10px; }
        
        /* åŠ¨æ€æ’‘å¼€åº•éƒ¨ï¼šå½“æ°”æ³¡æ˜¾ç¤ºæ—¶ï¼ŒJSä¼šæ·»åŠ  padding åˆ°çˆ¶å®¹å™¨ï¼Œè€Œä¸æ˜¯è¿™é‡Œ */
        
        /* æ°”æ³¡æç¤º (ä¿®å¤ç‰ˆ - 20sè‡ªåŠ¨æ¶ˆå¤±) */
        .bubble-tip { 
            position: absolute; 
            top: 45px; /* ä½äºæŒ‰é’®ä¸‹æ–¹ */
            left: 50%; 
            transform: translateX(-50%); 
            background: var(--danger); 
            color: white; 
            padding: 8px 10px; 
            border-radius: 10px; 
            font-size: 0.7em; 
            font-weight: bold; 
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4); 
            animation: bounce 1.5s infinite; 
            z-index: 99; 
            width: 140px; 
            white-space: normal; 
            text-align: center; 
            line-height: 1.3; 
            pointer-events: none;
            opacity: 0.95;
            transition: opacity 1s ease; /* æ¸éšåŠ¨ç”» */
        }
        .bubble-tip.fade-out { opacity: 0; }
        
        .bubble-tip::after { 
            content: ''; position: absolute; bottom: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: transparent transparent var(--danger) transparent; 
        }
        @keyframes bounce { 
            0%, 100% { transform: translateX(-50%) translateY(0); } 
            50% { transform: translateX(-50%) translateY(5px); } 
        }

        /* --- åˆ†éš”çº¿ --- */
        .divider { height: 1px; background: var(--border); margin: 20px 0; border: none; }

        /* --- è¿æ‹›æ€»ç»“ --- */
        .combo-box { 
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 15px; border-radius: 16px; margin-top: 20px; position: relative; box-shadow: 0 8px 15px rgba(0,0,0,0.2); 
            width: 100%; box-sizing: border-box;
        }
        [data-theme="dark"] .combo-box { background: linear-gradient(135deg, #1c1c1e 0%, #2c2c2e 100%); border: 1px solid #38383a; }
        .combo-title { font-size: 0.8em; font-weight: bold; opacity: 0.8; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; color: #ecf0f1; }
        .combo-text { font-size: 1.1em; font-weight: 600; line-height: 1.4; padding-right: 45px; margin-bottom: 10px; transition: all 0.3s; white-space: normal; word-wrap: break-word; }
        .structure-box { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; font-size: 0.8em; color: #bdc3c7; border: 1px dashed rgba(255,255,255,0.3); transition: all 0.3s; white-space: normal; }
        .struct-tag { display: inline-block; background: #e67e22; color: white; padding: 1px 5px; border-radius: 3px; font-size: 0.85em; margin-right: 4px; font-weight: bold; margin-bottom: 4px; }
        .struct-arrow { margin: 0 4px; color: #ecf0f1; }
        .combo-audio-btn { position: absolute; top: 15px; right: 15px; background: #27ae60; border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1em; box-shadow: 0 4px 8px rgba(39, 174, 96, 0.4); }
        
        /* --- æ‚¬æµ®æ§åˆ¶ç»„ --- */
        .float-controls { position: fixed; bottom: 40px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 2000; align-items: flex-end; }
        .fab-quiz { background: var(--danger); color: white; padding: 8px 16px; border-radius: 30px; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4); cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 6px; border: none; font-size: 0.85em; }
        .fab-quiz:active { transform: scale(0.95); }
        .fab-random { background: var(--accent); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2em; box-shadow: 0 4px 15px rgba(88, 86, 214, 0.4); border: none; cursor: pointer; }
        .quiz-active-text, body.quiz-mode .quiz-default-text { display: none; }
        body.quiz-mode .quiz-active-text { display: inline; }
        body.quiz-mode .fab-quiz { background: #34c759; box-shadow: 0 4px 15px rgba(52, 199, 89, 0.4); }

        /* --- ç‰¹è®­æ¨¡å¼ --- */
        body.quiz-mode .english-sentence { color: transparent !important; text-shadow: 0 0 13px rgba(128,128,128,0.5); user-select: none; }
        body.quiz-mode .english-sentence:active { color: var(--text-main) !important; text-shadow: none; }
        body.quiz-mode .pattern-box { color: transparent !important; background-color: var(--border); border-color: var(--border); user-select: none; }
        body.quiz-mode .pattern-box:active { color: #d63031 !important; background-color: #ffeaea; }
        body.quiz-mode .combo-text { color: transparent !important; text-shadow: 0 0 10px rgba(255,255,255,0.4); user-select: none; background: rgba(255,255,255,0.1); border-radius: 4px; }
        body.quiz-mode .combo-text:active { color: white !important; text-shadow: none; background: none; }
        body.quiz-mode .structure-box { color: transparent !important; text-shadow: 0 0 8px rgba(255,255,255,0.5); user-select: none; }
        body.quiz-mode .structure-box * { opacity: 0; }
        body.quiz-mode .structure-box:active { color: #bdc3c7 !important; text-shadow: none; }
        body.quiz-mode .structure-box:active * { opacity: 1; }

        /* --- åº”æ€¥æ¨¡å¼ Overlay --- */
        .emergency-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: none; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .emergency-overlay.active { display: flex; }
        .emergency-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 2em; cursor: pointer; padding: 10px; }
        .emergency-card { flex: 1; display: flex; align-items: center; justify-content: center; text-align: center; border-bottom: 1px solid #333; cursor: pointer; }
        .emergency-text { font-size: 2.2em; color: white; font-weight: bold; line-height: 1.2; text-transform: uppercase; margin-bottom: 10px; }
        .emergency-sub { font-size: 1.2em; color: #aaa; }

        /* --- å¼¹çª—é€šç”¨ --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 5000; display: none; align-items: center; justify-content: center; }
        .modal-card { background: var(--bg-card); width: 85%; max-width: 400px; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border); animation: popIn 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal-title { font-size: 1.2em; font-weight: bold; color: var(--text-sub); margin-bottom: 20px; text-transform: uppercase; }
        .modal-content-text { font-size: 1.2em; color: var(--text-main); margin-bottom: 30px; line-height: 1.5; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { padding: 8px 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 1em; }
        .btn-reveal { background: var(--primary); color: white; }
        .btn-close { background: var(--border); color: var(--text-main); }

        /* åº•éƒ¨ç‰ˆæƒ - æç®€æçª„ç‰ˆ */
        .fixed-footer { 
            flex: 0 0 auto;
            text-align: center; color: var(--text-sub); font-size: 0.6em; 
            padding: 3px 0; 
            border-top: 1px solid var(--border); 
            background: var(--bg-body);
            opacity: 0.5;
        }
    </style>
</head>
<body>

    <div class="header-container" id="mainHeader">
        <div class="top-row">
            <div class="app-title">ğŸ‡ºğŸ‡¸ Survival English Guide</div>
            <div class="header-actions">
                <button class="icon-btn danger" onclick="toggleEmergency()" title="åº”æ€¥æ¨¡å¼">âš¡</button>
                <button class="icon-btn" onclick="toggleTheme()" title="åˆ‡æ¢æ¨¡å¼">ğŸŒ—</button>
            </div>
        </div>
        <div class="search-row">
            <input type="text" class="search-input" id="searchBox" placeholder="ğŸ” æœç´¢åœºæ™¯ (å¦‚: é€€è´§, coffee...)" onkeyup="filterUnits()">
        </div>
        <div class="nav-scroll">
            <a onclick="scrollToUnit('u1')" class="nav-btn">é‚»å±…</a>
            <a onclick="scrollToUnit('u2')" class="nav-btn">ä½ç½®</a>
            <a onclick="scrollToUnit('u3')" class="nav-btn">æ´—æ‰‹é—´</a>
            <a onclick="scrollToUnit('u4')" class="nav-btn">é“¶è¡Œ</a>
            <a onclick="scrollToUnit('u5')" class="nav-btn">ç»“è´¦</a>
            <a onclick="scrollToUnit('u6')" class="nav-btn">ç‚¹é¤</a>
            <a onclick="scrollToUnit('u7')" class="nav-btn">èšé¤</a>
            <a onclick="scrollToUnit('u8')" class="nav-btn">å™æ—§</a>
            <a onclick="scrollToUnit('u9')" class="nav-btn">æ‰“è½¦</a>
            <a onclick="scrollToUnit('u10')" class="nav-btn">æ€¥æ•‘</a>
            <a onclick="scrollToUnit('u11')" class="nav-btn">æ²¡å¬æ‡‚</a>
            <a onclick="scrollToUnit('u12')" class="nav-btn">é€€è´§</a>
            <a onclick="scrollToUnit('u13')" class="nav-btn">é¢„çº¦</a>
        </div>
    </div>

    <div class="emergency-overlay" id="emergencyOverlay">
        <div class="emergency-close" onclick="toggleEmergency()">âœ•</div>
        <div class="emergency-card" onclick="speakDirect('I need help! Please call 911.')">
            <div><div class="emergency-text" style="color: #ff3b30;">I NEED HELP!<br>CALL 911</div><div class="emergency-sub">æ•‘å‘½ï¼è¯·æ‰“911</div></div>
        </div>
        <div class="emergency-card" onclick="speakDirect('I do not speak English. Please use a translation app.')">
            <div><div class="emergency-text">I DON'T SPEAK ENGLISH</div><div class="emergency-sub">æˆ‘ä¸ä¼šè‹±è¯­ (è¯·ç”¨ç¿»è¯‘è½¯ä»¶)</div></div>
        </div>
        <div class="emergency-card" onclick="speakDirect('I am lost. Can you help me?')">
            <div><div class="emergency-text">I AM LOST<br>CAN YOU HELP?</div><div class="emergency-sub">æˆ‘è¿·è·¯äº†ï¼Œèƒ½å¸®æˆ‘å—ï¼Ÿ</div></div>
        </div>
    </div>

    <div class="modal-overlay" id="randomModal">
        <div class="modal-card">
            <div class="modal-title">ğŸ² éšæœºåœºæ™¯æŒ‘æˆ˜</div>
            <div class="modal-content-text" id="modalQuestion" style="font-weight:bold; font-size: 1.4em;">...</div>
            <div class="modal-actions">
                <button class="modal-btn btn-close" onclick="closeModal('randomModal')">å…³é—­</button>
                <button class="modal-btn btn-reveal" onclick="revealRandomAnswer()">æŸ¥çœ‹ç­”æ¡ˆ</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reportModal">
        <div class="modal-card">
            <div class="modal-title">ğŸ“… æœˆåº¦æš–å¿ƒå°ç»“</div>
            <div class="modal-content-text" id="reportContent" style="text-align: left; font-size: 1em;">...</div>
            <div class="modal-actions">
                <button class="modal-btn btn-reveal" onclick="closeModal('reportModal')">ç»§ç»­åŠ æ²¹ï¼</button>
            </div>
        </div>
    </div>

    <div class="float-controls">
        <button class="fab-random" onclick="startRandomDrill()" title="éšæœºæŠ½æŸ¥">ğŸ²</button>
        <button class="fab-quiz" onclick="toggleQuizMode()">
            <span class="quiz-default-text">ğŸ‘ï¸ é®æŒ¡ç‰¹è®­</span>
            <span class="quiz-active-text">âœ… æ¢å¤æ˜¾ç¤º</span>
        </button>
    </div>

    <div id="content-area">
        <div class="unit-card" id="u1" data-name="é‚»å±…æ‰“æ‹›å‘¼" data-keywords="é‚»å±… æ‰“æ‹›å‘¼ ä»‹ç» neighbor">
            <div class="unit-header">é‚»å±…æ‰“æ‹›å‘¼<span class="sort-rank"></span></div>
            <div class="step-container">
                <span class="step-label">Step 1: ä»‹ç» <span class="pattern-box">Hi, I'm ...</span></span>
                <div class="display-area">
                    <div class="text-content">
                        <div class="english-sentence">Hi, I'm <span class="highlight" id="u1-s1-word">your new neighbor</span>.</div>
                        <div class="translation" id="u1-s1-trans">å—¨ï¼Œæˆ‘æ˜¯ä½ çš„æ–°é‚»å±…ã€‚</div>
                    </div>
                    <button class="btn-audio" onclick="speakWholeSentence('u1-s1-word', 'Hi, I am', '.')">ğŸ”Š</button>
                </div>
                <div class="chips-container" id="u1-s1-chips">
                    <div class="chip active" onclick="updateUnit(1, 1, 'your new neighbor', 'ä½ çš„æ–°é‚»å±…', 'Hi, I am', '', this)">your new neighbor</div>
                    <div class="chip" onclick="updateUnit(1, 1, 'David', 'David', 'Hi, I am', '', this)">David</div>
                    <div class="chip" onclick="updateUnit(1, 1, 'moving in', 'åˆšæ¬è¿›æ¥', 'Hi, I am', '', this)">moving in</div>
                    <div class="chip" onclick="updateUnit(1, 1, 'visiting my aunt', 'æ¥çœ‹æˆ‘é˜¿å§¨çš„', 'Hi, I am', '', this)">visiting my aunt</div>
                    
                    <div class="add-btn-wrapper">
                        <button class="chip add-chip-btn" onclick="addCustomChip(1, 1, 'Hi, I am', '')">ï¼‹</button>
                    </div>
                </div>
            </div>
            <hr class="divider">
            <div class="step-container">
                <span class="step-label">Step 2: ä½å€ <span class="pattern-box">I live in ...</span></span>
                <div class="display-area">
                    <div class="text-content">
                        <div class="english-sentence">I live in <span class="highlight" id="u1-s2-word">Apt 302</span>.</div>
                        <div class="translation" id="u1-s2-trans">æˆ‘ä½åœ¨302å®¤ã€‚</div>
                    </div>
                    <button class="btn-audio" onclick="speakWholeSentence('u1-s2-word', 'I live in', '.')">ğŸ”Š</button>
                </div>
                <div class="chips-container" id="u1-s2-chips">
                    <div class="chip active" onclick="updateUnit(1, 2, 'Apt 302', '302å®¤', 'I live in', '', this)">Apt 302</div>
                    <div class="chip" onclick="updateUnit(1, 2, 'next door', 'éš”å£', 'I live', '', this)">next door</div>
                    <div class="chip" onclick="updateUnit(1, 2, 'downstairs', 'æ¥¼ä¸‹', 'I live', '', this)">downstairs</div>
                    <button class="chip add-chip-btn" onclick="addCustomChip(1, 2, 'I live in', '')">ï¼‹</button>
                </div>
            </div>
            <div class="combo-box">
                <div class="combo-title">ğŸš€ é€»è¾‘æ„é€  (ç¤ºä¾‹é€ å¥)</div>
                <div class="combo-text">"Hi, I'm your new neighbor. I live in Apt 302, nice to meet you."</div>
                <div class="structure-box"><span class="struct-tag">æˆ‘æ˜¯è°</span> I'm [Name] <span class="struct-arrow">âœ</span> <span class="struct-tag">ä½å“ªé‡Œ</span> I live in [Location].</div>
                <button class="combo-audio-btn" onclick="speakDirect('Hi, I am your new neighbor. I live in Apt 302, nice to meet you.')">ğŸ”Š</button>
            </div>
        </div>

        </div>

    <div class="fixed-footer">
        <p>&copy; <span id="year"></span> Henry's Survival English Guide.</p>
    </div>

    <script>
        // === æ ¸å¿ƒé€»è¾‘ ===
        let usageData = {};
        let currentRandomUnit = null;
        let pressTimer;

        // 1. åˆå§‹åŒ–
        window.onload = function() {
            document.getElementById('year').innerText = new Date().getFullYear();
            loadTheme();
            loadCustomChips();
            loadUsageData();
            checkMonthlyReport(); 
            
            // å…ˆæ’åº
            autoSortUnits();

            // æ¢å¤ä¸Šæ¬¡é€‰æ‹©
            for (let i = 1; i <= 13; i++) {
                if(document.getElementById(`u${i}`)) {
                    restoreSelection(i, 1);
                    restoreSelection(i, 2);
                }
            }
            
            // æ’åºå®Œæˆåï¼Œæ˜¾ç¤ºæ™ºèƒ½æ°”æ³¡
            initBubbleTip();
        };

        // 2. æ™ºèƒ½æ°”æ³¡å¼•å¯¼ (æ ¸å¿ƒä¿®å¤)
        function initBubbleTip() {
            // å¦‚æœå·²Dismissï¼Œåˆ™ä¸æ˜¾ç¤º
            if (localStorage.getItem('bubble_dismissed') === 'true') return;

            const container = document.getElementById('content-area');
            // è·å–æ’åºåçš„ç¬¬ä¸€å¼ å¡ç‰‡
            const firstCard = container.firstElementChild; 
            if (!firstCard || !firstCard.classList.contains('unit-card')) return;

            // æ‰¾åˆ°ç¬¬ä¸€å¼ å¡ç‰‡çš„ Step 1 é‡Œçš„æ·»åŠ æŒ‰é’®å®¹å™¨
            const wrapper = firstCard.querySelector('.step-container .chips-container .add-btn-wrapper');
            if (wrapper) {
                // åˆ›å»ºæ°”æ³¡
                const bubble = document.createElement('div');
                bubble.className = 'bubble-tip';
                bubble.innerText = 'æ²¡æœ‰ä½ æƒ³è¦çš„ï¼Ÿè¿™é‡Œå¯ä»¥è‡ªå·±æ·»åŠ å¹¶ä¸”ä¹Ÿå¯ä»¥å‘éŸ³å“¦ï¼';
                
                wrapper.appendChild(bubble);
                
                // å…³é”®ï¼šç»™ chips-container æ·»åŠ  paddingï¼Œé˜²æ­¢æ°”æ³¡è¢«åˆ‡
                const chipsContainer = wrapper.closest('.chips-container');
                if(chipsContainer) {
                    chipsContainer.style.paddingBottom = '60px'; 
                    chipsContainer.setAttribute('data-has-bubble', 'true');
                }

                // 20ç§’åè‡ªåŠ¨æ¶ˆå¤±
                setTimeout(() => {
                    dismissBubble(bubble);
                }, 20000);
            }
        }

        function dismissBubble(element) {
            if(!element) return;
            element.classList.add('fade-out');
            
            // ç§»é™¤æ°”æ³¡ DOM
            setTimeout(() => {
                const wrapper = element.parentElement;
                if(wrapper) {
                    const chipsContainer = wrapper.closest('.chips-container');
                    // ç§»é™¤ paddingï¼Œæ¢å¤åŸæ ·
                    if(chipsContainer && chipsContainer.getAttribute('data-has-bubble') === 'true') {
                        chipsContainer.style.paddingBottom = '';
                        chipsContainer.removeAttribute('data-has-bubble');
                    }
                }
                element.remove();
            }, 1000);
            
            // æ°¸ä¹…ä¸å†æ˜¾ç¤º
            localStorage.setItem('bubble_dismissed', 'true');
        }

        // 3. è‡ªå®šä¹‰è¯åº“ (å…³è”æ°”æ³¡æ¶ˆé™¤)
        function addCustomChip(unitNum, stepNum, prefix, suffix) {
            // ç‚¹å‡»åŠ å·ï¼Œç«‹å³æ¶ˆé™¤æ°”æ³¡
            const bubble = document.querySelector('.bubble-tip');
            if(bubble) dismissBubble(bubble);

            const eng = prompt("è¯·è¾“å…¥è‹±æ–‡å•è¯æˆ–çŸ­è¯­ (e.g. oat milk):"); if(!eng) return;
            const cn = prompt("è¯·è¾“å…¥ä¸­æ–‡æ„æ€ (e.g. ç‡•éº¦å¥¶):"); if(!cn) return;

            const chipData = { unitNum, stepNum, eng, cn, prefix, suffix };
            const key = `custom_chips_u${unitNum}_s${stepNum}`;
            let list = JSON.parse(localStorage.getItem(key) || "[]");
            list.push(chipData);
            localStorage.setItem(key, JSON.stringify(list));

            renderAndClickChip(chipData, true);
        }

        // 4. ç´§æ€¥æ¨¡å¼
        function toggleEmergency() {
            const overlay = document.getElementById('emergencyOverlay');
            overlay.classList.toggle('active');
        }

        // 5. æ™ºèƒ½æ’åº
        function loadUsageData() {
            usageData = JSON.parse(localStorage.getItem('unit_usage') || "{}");
        }

        function autoSortUnits() {
            const container = document.getElementById('content-area');
            const cards = Array.from(container.getElementsByClassName('unit-card'));

            cards.sort((a, b) => {
                const idA = parseInt(a.id.replace('u', ''));
                const idB = parseInt(b.id.replace('u', ''));
                const usageA = usageData[idA] || 0;
                const usageB = usageData[idB] || 0;
                if (usageA === usageB) return idA - idB;
                return usageA - usageB; 
            });

            cards.forEach(card => container.appendChild(card));
        }

        function incrementUsage(unitNum) {
            usageData[unitNum] = (usageData[unitNum] || 0) + 1;
            localStorage.setItem('unit_usage', JSON.stringify(usageData));
        }

        // 6. æœˆåº¦æŠ¥å‘Š
        function checkMonthlyReport() {
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${now.getMonth() + 1}`; 
            const storedMonth = localStorage.getItem('stats_last_month');
            
            let openCount = parseInt(localStorage.getItem('stats_open_count') || "0") + 1;
            localStorage.setItem('stats_open_count', openCount);

            if (storedMonth && storedMonth !== currentMonth) {
                showMonthlySummary(storedMonth);
                localStorage.setItem('stats_open_count', 1);
            }
            
            localStorage.setItem('stats_last_month', currentMonth);
        }

        function showMonthlySummary(monthStr) {
            const openCount = localStorage.getItem('stats_open_count');
            let maxId = null, minId = null;
            let maxVal = -1, minVal = 999999;
            
            for(let i=1; i<=13; i++) {
                let val = usageData[i] || 0;
                if(val > maxVal) { maxVal = val; maxId = i; }
                if(val < minVal) { minVal = val; minId = i; }
            }

            let msg = `å˜¿ï¼è€æœ‹å‹ï¼Œ${monthStr.split('-')[1]}æœˆè¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ<br><br>`;
            msg += `è¿™ä¸ªæœˆä½ ä¸€å…±æ‰“å¼€äº†è¿™é‡Œ <b>${openCount}</b> æ¬¡ã€‚<br>`;
            
            if(openCount > 20) {
                msg += "ğŸ‰ å¤ªæ£’äº†ï¼è¯·åŠ¡å¿…ä¿æŒè¿™ä¸ªèŠ‚å¥ï¼<br><br>";
            } else {
                msg += "ğŸ¥º è®°å¾—å¸¸æ¥çœ‹çœ‹æˆ‘å“¦~<br><br>";
            }

            const getName = (id) => {
                const el = document.getElementById(`u${id}`);
                return el ? el.getAttribute('data-name') : "æœªçŸ¥";
            };

            if(maxId) msg += `ğŸ”¥ æœ€å¸¸ç»ƒä¹ ï¼š<b>${getName(maxId)}</b><br>`;
            if(minId) msg += `ğŸ§Š ç»ƒå¾—æœ€å°‘ï¼š<b>${getName(minId)}</b>`;

            document.getElementById('reportContent').innerHTML = msg;
            document.getElementById('reportModal').style.display = 'flex';
        }

        // 7. éšæœºæŠ½æŸ¥
        function startRandomDrill() {
            const u = Math.floor(Math.random() * 13) + 1; 
            const unitCard = document.getElementById(`u${u}`);
            if(!unitCard) { startRandomDrill(); return; } 
            
            const rawTitle = unitCard.querySelector('.unit-header').childNodes[0].textContent.trim();
            const modal = document.getElementById('randomModal');
            document.getElementById('modalQuestion').innerText = `${rawTitle}`;
            modal.style.display = 'flex';
            currentRandomUnit = u;
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function revealRandomAnswer() {
            closeModal('randomModal');
            scrollToUnit(`u${currentRandomUnit}`);
        }

        // 8. å¯¼èˆª
        function scrollToUnit(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        // 9. åŸºç¡€åŠŸèƒ½
        function toggleTheme() {
            const html = document.documentElement;
            const newTheme = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        function loadTheme() {
            const saved = localStorage.getItem('theme');
            if(saved) document.documentElement.setAttribute('data-theme', saved);
        }

        function filterUnits() {
            const filter = document.getElementById('searchBox').value.toLowerCase();
            const cards = document.getElementsByClassName('unit-card');
            for(let card of cards) {
                const text = card.innerText.toLowerCase();
                const keys = card.getAttribute('data-keywords') || "";
                card.style.display = (text.includes(filter) || keys.includes(filter)) ? "" : "none";
            }
        }

        function loadCustomChips() {
            for(let u=1; u<=13; u++) {
                for(let s=1; s<=2; s++) {
                    const list = JSON.parse(localStorage.getItem(`custom_chips_u${u}_s${s}`) || "[]");
                    list.forEach(d => renderAndClickChip(d, false));
                }
            }
        }

        function renderAndClickChip(data, triggerClick) {
            const container = document.getElementById(`u${data.unitNum}-s${data.stepNum}-chips`);
            if(!container) return;

            const btn = document.createElement('div');
            btn.className = 'chip';
            btn.innerText = data.eng;
            
            btn.onmousedown = btn.ontouchstart = function() {
                pressTimer = setTimeout(() => {
                    if(confirm(`ç®¡ç† "${data.eng}":\nç‚¹å‡»[ç¡®å®š]ä¿®æ”¹ï¼Œç‚¹å‡»[å–æ¶ˆ]ç»§ç»­ã€‚`)) {
                        const newTxt = prompt("ä¿®æ”¹è‹±æ–‡ (ç•™ç©ºåˆ™åˆ é™¤):", data.eng);
                        if(newTxt === null) return; 
                        updateCustomChipInStorage(data, newTxt);
                        if(newTxt === "") {
                            btn.remove();
                        } else {
                            btn.innerText = newTxt;
                            data.eng = newTxt;
                        }
                    }
                }, 800);
            };
            btn.onmouseup = btn.ontouchend = function() { clearTimeout(pressTimer); };

            btn.onclick = function() { updateUnit(data.unitNum, data.stepNum, data.eng, data.cn, data.prefix, data.suffix, this); };
            
            const wrapper = container.querySelector('.add-btn-wrapper');
            if(wrapper) container.insertBefore(btn, wrapper);
            else {
                const addBtn = container.querySelector('.add-chip-btn');
                if(addBtn) container.insertBefore(btn, addBtn);
                else container.appendChild(btn);
            }

            if (triggerClick) btn.click();
        }

        function updateCustomChipInStorage(oldData, newEng) {
            const key = `custom_chips_u${oldData.unitNum}_s${oldData.stepNum}`;
            let list = JSON.parse(localStorage.getItem(key) || "[]");
            if(newEng === "") {
                list = list.filter(item => item.eng !== oldData.eng);
            } else {
                const idx = list.findIndex(item => item.eng === oldData.eng);
                if(idx > -1) list[idx].eng = newEng;
            }
            localStorage.setItem(key, JSON.stringify(list));
        }

        function toggleQuizMode() { document.body.classList.toggle('quiz-mode'); }

        // æ ¸å¿ƒæ›´æ–°
        function updateUnit(unitNum, stepNum, engWord, cnWord, prefixEng, suffixCn, element, playSound = true) {
            incrementUsage(unitNum);

            const wordId = `u${unitNum}-s${stepNum}-word`;
            const displayEl = document.getElementById(wordId);
            if(displayEl) displayEl.innerText = engWord;
            
            let fullCn = "";
            // é€šç”¨é€»è¾‘ 
            if (unitNum === 1 && stepNum === 1) fullCn = "å—¨ï¼Œæˆ‘æ˜¯" + cnWord + "ã€‚";
            else if (unitNum === 1 && stepNum === 2) fullCn = "æˆ‘ä½åœ¨" + cnWord + "ã€‚";
            else if (unitNum === 2 && stepNum === 1) fullCn = "æ‰“æ‰°ä¸€ä¸‹ï¼Œæˆ‘åœ¨æ‰¾" + cnWord + "ã€‚";
            else if (unitNum === 2 && stepNum === 2) fullCn = "èƒ½å‘Šè¯‰æˆ‘" + cnWord + suffixCn + "ï¼Ÿ";
            else if (unitNum === 3 && stepNum === 1) fullCn = "æˆ‘èƒ½å€Ÿç”¨ä¸€ä¸‹æ‚¨çš„" + cnWord + suffixCn + "ï¼Ÿ";
            else if (unitNum === 3 && stepNum === 2) fullCn = "çœŸçš„" + cnWord + "ã€‚";
            else if (unitNum === 4 && stepNum === 1) fullCn = "æˆ‘æƒ³è¦" + cnWord + "ã€‚";
            else if (unitNum === 4 && stepNum === 2) fullCn = "è¿™æ˜¯æˆ‘çš„" + cnWord + "ã€‚";
            else if (unitNum === 5 && stepNum === 1) fullCn = "ä½ ä»¬æ”¶" + cnWord + suffixCn + "ï¼Ÿ";
            else if (unitNum === 5 && stepNum === 2) fullCn = "æˆ‘è¿˜æƒ³è¦" + cnWord + "ã€‚";
            else if (unitNum === 6 && stepNum === 1) fullCn = "æˆ‘èƒ½è¦ä¸€ä¸ª" + cnWord + "å—ï¼Ÿ";
            else if (unitNum === 6 && stepNum === 2) fullCn = "è¦åšæˆ" + cnWord + "çš„ã€‚";
            else if (unitNum === 7 && stepNum === 1) fullCn = "è¿™" + cnWord + "å¤ªæ£’äº†ï¼";
            else if (unitNum === 7 && stepNum === 2) fullCn = "æˆ‘æ¥å¸®å¿™" + cnWord + "ã€‚";
            else if (unitNum === 8 && stepNum === 1) fullCn = "æˆ‘ä»¬å¥½ä¹…æ²¡" + cnWord + "äº†ã€‚";
            else if (unitNum === 8 && stepNum === 2) fullCn = "ä½ æœ€è¿‘" + cnWord + "ï¼Ÿ";
            else if (unitNum === 9 && stepNum === 1) fullCn = "æˆ‘è¦å»" + cnWord + "ã€‚";
            else if (unitNum === 9 && stepNum === 2) fullCn = "è¯·åœ¨" + cnWord + "æ”¾æˆ‘ä¸‹æ¥ã€‚";
            else if (unitNum === 10 && stepNum === 1) fullCn = cnWord + "äº†ï¼";
            else if (unitNum === 10 && stepNum === 2) fullCn = "æ‰“" + cnWord + "ï¼";
            else if (unitNum === 11 && stepNum === 1) fullCn = "æŠ±æ­‰ï¼Œæˆ‘æ²¡" + cnWord + "ã€‚";
            else if (unitNum === 11 && stepNum === 2) fullCn = "ä½ èƒ½" + cnWord + "å—ï¼Ÿ";
            else if (unitNum === 12 && stepNum === 1) fullCn = "æˆ‘æƒ³è¦" + cnWord + "ã€‚";
            else if (unitNum === 12 && stepNum === 2) fullCn = "å®ƒ" + cnWord + "ã€‚";
            else if (unitNum === 13 && stepNum === 1) fullCn = "æˆ‘æƒ³é¢„çº¦" + cnWord + "ã€‚";
            else if (unitNum === 13 && stepNum === 2) fullCn = cnWord + "æœ‰ç©ºå—ï¼Ÿ";
            else fullCn = cnWord + (suffixCn ? suffixCn : "ã€‚");

            const transEl = document.getElementById(`u${unitNum}-s${stepNum}-trans`);
            if(transEl) transEl.innerText = fullCn;

            let container = element.parentElement;
            if (container.classList.contains('add-btn-wrapper')) container = container.parentElement.parentElement; 
            
            // Safe selector
            let chips = container.querySelectorAll('.chip');
            for(let chip of chips) chip.classList.remove('active');
            element.classList.add('active');

            localStorage.setItem(`u${unitNum}-s${stepNum}`, JSON.stringify({ engWord, cnWord, prefix: prefixEng, suffix: suffixCn }));
            if(playSound) speakDirect(engWord);
        }

        function restoreSelection(unitNum, stepNum) {
            const savedData = localStorage.getItem(`u${unitNum}-s${stepNum}`);
            if (savedData) {
                const data = JSON.parse(savedData);
                const container = document.getElementById(`u${unitNum}-s${stepNum}-chips`);
                if(container) {
                    const chips = container.querySelectorAll('.chip');
                    for(let chip of chips) {
                        if(chip.innerText === data.engWord) {
                            updateUnit(unitNum, stepNum, data.engWord, data.cnWord, data.prefix, data.suffix, chip, false);
                            break;
                        }
                    }
                }
            }
        }

        function speakWholeSentence(wordId, prefix, punctuation) {
            let word = document.getElementById(wordId).innerText;
            speakDirect(prefix + " " + word + punctuation);
        }

        function speakDirect(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9; 
            window.speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>
